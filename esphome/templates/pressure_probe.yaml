sensor:
  - platform: adc
    pin: ${probe_pin}
    name: "Raw Voltage ${probe_id}"
    id: pressure_voltage_${probe_id}
    update_interval: 60s
    attenuation: 12db
    unit_of_measurement: "V"
    accuracy_decimals: 3
    filters:
      - lambda: |-
          static const int WINDOW_SIZE = 8;
          static float buf[WINDOW_SIZE];
          static int idx = 0, cnt = 0;
          const float THRESH = 0.15;

          ESP_LOGD("pressure_${probe_id}", "ADC raw input: %.3f V", x);

          buf[idx] = x;
          idx = (idx + 1) % WINDOW_SIZE;
          if (cnt < WINDOW_SIZE) cnt++;

          float sum = 0;
          for (int i = 0; i < cnt; i++) sum += buf[i];
          float avg = sum / cnt;

          float voltage;
          if (cnt < WINDOW_SIZE) {
            voltage = x;
            ESP_LOGD("pressure_${probe_id}", "Still filling buffer");
          } else if (fabs(x - avg) <= THRESH) {
            voltage = avg;
            ESP_LOGD("pressure_${probe_id}", "Value inside the corridor. Averaging...");
          } else {
            voltage = x;
            buf[0] = x;
            cnt = 1;
            idx = 1;
            ESP_LOGD("pressure_${probe_id}", "Voltage spike/drop > %.3f V (%.3f). Resetting ring buffer", THRESH, fabs(x - avg));
          }

          ESP_LOGD("pressure_${probe_id}", "Filtered voltage: %.3f V (avg=%.3f V)", voltage, avg);
          return voltage;

  - platform: template
    name: "PSI ${probe_id}"
    id: psi_${probe_id}
    unit_of_measurement: "psi"
    accuracy_decimals: 1
    update_interval: 60s
    device_class: pressure
    state_class: measurement
    lambda: |-
      float voltage = id(pressure_voltage_${probe_id}).state;
      if (isnan(voltage)) {
        ESP_LOGW("pressure_${probe_id}", "Waiting for first voltage reading");
        return NAN;
      }

      auto* cal = find_calibration("${calibration_id}");
      if (!cal) {
        ESP_LOGE("pressure_${probe_id}", "Unknown calibration table: ${calibration_id}");
        return NAN;
      }

      const float (*table)[2] = cal->points;
      const int TABLE_SIZE = cal->size;
      const float EPSILON = 0.0001;

      if (voltage < table[0][0] - EPSILON) return 0.0;
      if (voltage > table[TABLE_SIZE - 1][0] + EPSILON) return 100.0;

      for (int i = 0; i < TABLE_SIZE - 1; i++) {
        float x0 = table[i][0], x1 = table[i+1][0];
        if (voltage >= x0 - EPSILON && voltage <= x1 + EPSILON) {
          float y0 = table[i][1], y1 = table[i+1][1];
          float p = y0 + (voltage - x0)*(y1 - y0)/(x1 - x0);
          ESP_LOGD("pressure_${probe_id}", "Interpolated pressure: %.1f PSI", p);
          return p;
        }
      }

      ESP_LOGW("pressure_${probe_id}", "Lookup failure");
      return 0.0;
