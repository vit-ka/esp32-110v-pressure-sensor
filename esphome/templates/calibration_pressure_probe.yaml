sensor:
  - platform: adc
    pin: ${probe_pin}
    name: "Cal Raw Voltage ${probe_id}"
    id: cal_voltage_${probe_id}
    update_interval: 1s
    attenuation: 12db
    unit_of_measurement: "V"
    accuracy_decimals: 3
    on_value:
      then:
        - lambda: |-
            float raw = x;

            // Moving average (10-sample window)
            static float buf[10];
            static int idx = 0, cnt = 0;
            buf[idx] = raw;
            idx = (idx + 1) % 10;
            if (cnt < 10) cnt++;
            float sum = 0;
            for (int i = 0; i < cnt; i++) sum += buf[i];
            float avg = sum / cnt;

            // PSI interpolation
            auto* cal = find_calibration("${calibration_id}");
            if (!cal) {
              ESP_LOGE("cal_${probe_id}", "Unknown calibration table: ${calibration_id}");
              return;
            }

            const float (*table)[2] = cal->points;
            const int TABLE_SIZE = cal->size;
            float psi = 0.0;

            if (raw < table[0][0]) {
              psi = 0.0;
            } else if (raw > table[TABLE_SIZE - 1][0]) {
              psi = table[TABLE_SIZE - 1][1];
            } else {
              for (int i = 0; i < TABLE_SIZE - 1; i++) {
                float x0 = table[i][0], x1 = table[i+1][0];
                if (raw >= x0 && raw <= x1) {
                  float y0 = table[i][1], y1 = table[i+1][1];
                  psi = y0 + (raw - x0) * (y1 - y0) / (x1 - x0);
                  break;
                }
              }
            }

            ESP_LOGI("cal", "${probe_pin}  Raw: %5.3f V  Avg: %5.3f V  PSI: %5.1f", raw, avg, psi);
